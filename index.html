<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>Baum: Assignment</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.8/js/esri/css/esri.css">
    <style>
        html,
        body,
        #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            background-color: #FFF;
            overflow: hidden;
            font-family: "Trebuchet MS";
        }
        #home {
            position: absolute;
            top: 120px;
            left: 20px;
            z-index: 1;
        }
        #geocoder{
            position: absolute;
            top: 40px;
            left: 75px;
            z-index: 2;
        }
        #BasemapToggle {
            position: absolute;
            top: 80px;
            left: 75px;
            z-index: 3;
        }
        #info {
            position: absolute;
            right: 0;
            top: 0;
            padding: 10px;
            background-color: #ccc;
            font: Verdana;
            width: 350px;
            z-index: 4;
            text-align: left;
            border-radius: 0 0 0 10px;
        }
        <!--The z-index property specifies the stack order of an element. 
          An element with greater stack order is always in front of an element with a lower stack order.-->
    </style>
    <script src="http://js.arcgis.com/3.8/"></script>
    <script>
        var map;
        var geocoder;
        var swipeWidget;
        //Add reference to the modules in require()
        require(["esri/map",
                 "esri/dijit/HomeButton",
                 "esri/dijit/BasemapToggle",
                 "esri/dijit/Geocoder",
                 "esri/dijit/LayerSwipe",
                 "esri/dijit/Legend",
                 "esri/dijit/PopupTemplate",
                 "esri/layers/FeatureLayer",
                 "esri/symbols/SimpleLineSymbol",
                 "esri/symbols/SimpleFillSymbol",
                 "esri/renderers/ClassBreaksRenderer",
                 "esri/renderers/SimpleRenderer",
                 "esri/renderers/UniqueValueRenderer",
                 "dojo/_base/array",
                 "dojo/_base/Color",
                 "dojo/dom",
                 "dojo/on",
                 "dojo/domReady!"], 
            function(Map,HomeButton,BasemapToggle,Geocoder,LayerSwipe,Legend,PopupTemplate,FeatureLayer,SimpleLineSymbol,SimpleFillSymbol,ClassBreaksRenderer,SimpleRenderer,UniqueValueRenderer,arrayUtils,Color,dom,on) {
                map = new Map("map", {
                    basemap: "gray",
                    center: [-90.5,38.5], // long, lat
                    zoom: 12,
                    sliderStyle: "small"
                });

                //Create an instance of the Geocoder widget
                //another parameter we can pass to Geocoder is autoComplete
                geocoder = new Geocoder({
                    map:map,
                    autoComplete:false,
                    value: "St. Louis, MO"
                },"geocoder");
                geocoder.startup();

                //Create an instance of the HomeButton widget 
                //add a reference to the map, second parameter is where to attach the widget
                var home = new HomeButton({
                    map:map
                },"home");
                home.startup();

                var toggle = new BasemapToggle({
                    map: map,
                    basemap: "satellite"
                }, "BasemapToggle");
                toggle.startup();
                      
                //Add popup infobox for losing gaining stream segments
                var template_lgss = new PopupTemplate({
                    title: "{CLASS_} Stream Segment",
                    fieldInfos: [{
                        fieldName: "STR_NAME",
                        visible: true,
                        label: "Stream Name:"
                    }, {
                        fieldName: "CLASS_",
                        visible: true,
                        label: "Class:"
                    }, {
                        fieldName: "MILES",
                        visible: true,
                        label: "Length (miles):",
                        format: {
                            places: 0
                        }
                    }]
                });

                //mediaInfos:[{
                //  caption: "Details",
                //    type:"barchart",
                //    value:{
                //      theme: "ThreeD",
                //      fields:["WHITE10","BLACK10","HISP10"],
                //      normalizeField:"POP10"  
                //    }
                //  }]
        
                //define user-defined layers from ArcGIS server // new FeatureLayer(url,{options?})
                
                // define MO 1995 State Hydrography
                var mo1995StateHydrography = new FeatureLayer("http://msdisweb.missouri.edu/ArcGIS/rest/services/MSDIS_Download/MapServer/166", {
                    mode: FeatureLayer.MODE_ONDEMAND, //query mode for the feature layer. MODE_ONDEMAND - features are fetched from the server as needed.
                    outFields: ["LOSING"] //A comma delimited list of field names to include in the FeatureLayer. If not specified, the feature layer will return the OBJECTID field
                });
                
                // define MO 2011 Losing Gaining Stream Segments layer
                //var mo2011LosingGainingStreamSegments = new FeatureLayer("http://msdisweb.missouri.edu/ArcGIS/rest/services/MSDIS_Download/MapServer/156", {
                //    mode: FeatureLayer.MODE_ONDEMAND, //query mode for the feature layer. MODE_ONDEMAND - features are fetched from the server as needed.
                //    outFields: ["STR_NAME", "CLASS_", "MILES"], //A comma delimited list of field names to include in the FeatureLayer. If not specified, the feature layer will return the OBJECTID field
                //    infoTemplate: template_lgss
                //});

                // define MO 2013 Losing Gaining Stream Segments layer
                var mo2013LosingGainingStreamSegments = new FeatureLayer("http://msdisweb.missouri.edu/ArcGIS/rest/services/MSDIS_Download/MapServer/149", {
                    mode: FeatureLayer.MODE_ONDEMAND, //query mode for the feature layer. MODE_ONDEMAND - features are fetched from the server as needed.
                    outFields: ["STR_NAME", "CLASS_", "MILES"], //A comma delimited list of field names to include in the FeatureLayer. If not specified, the feature layer will return the OBJECTID field
                    infoTemplate: template_lgss
                });
                
                //define Groundwater Elevation layer
                //var mo2006GroundwaterElevation = new FeatureLayer("http://msdisweb.missouri.edu/ArcGIS/rest/services/MSDIS_Download/MapServer/162", {
                //    mode: FeatureLayer.MODE_ONDEMAND, //query mode for the feature layer. MODE_ONDEMAND - features are fetched from the server as needed.
                //    outFields: ["CONTOUR"], //A comma delimited list of field names to include in the FeatureLayer. If not specified, the feature layer will return the OBJECTID field
                //    opacity: 1.0
                //});
                
                //define Depth to Groundwater layer
                var mo2006DepthToGroundwater = new FeatureLayer("http://msdisweb.missouri.edu/ArcGIS/rest/services/MSDIS_Download/MapServer/163", {
                    mode: FeatureLayer.MODE_ONDEMAND, //query mode for the feature layer. MODE_ONDEMAND - features are fetched from the server as needed.
                    outFields: ["CONTOUR"], //A comma delimited list of field names to include in the FeatureLayer. If not specified, the feature layer will return the OBJECTID field
                    opacity: 1.0
                });
                
                // The LayerSwipe widget seems to interfere with the PopupTemplate widget
                // displaying the information box
                /*
                swipeWidget = new LayerSwipe({
                   type: "vertical",
                   map: map,
                   layers: [mo1995StateHydrography, mo2013LosingGainingStreamSegments]
                }, "swipeDiv");
                swipeWidget.startup(); */
                    
                //Use renderer to create a color ramp for quantitative data
               /*mo2006DepthToGroundwater.on("load", function() {
                
                    var defaultLineSymbol = new SimpleLineSymbol();
                    defaultLineSymbol.setColor(new Color([150, 150, 150, 0.5]));

                    // Add five breaks to the renderer.
                    // If you have ESRI's ArcMap available, this can be a good way to determine break values.
                    // You can also copy the RGB values from the color schemes ArcMap applies, or use colors
                    // from a site like www.colorbrewer.org
                    //
                    // alternatively, ArcGIS Server's generate renderer task could be used
                    var renderer = new ClassBreaksRenderer(defaultLineSymbol, "CONTOUR");
                    renderer.addBreak(0, 500, new SimpleLineSymbol().setColor(new Color([0, 0, 255, 1.0])));
                    renderer.addBreak(500, 750, new SimpleLineSymbol().setColor(new Color([51, 194, 255, 1.0])));
                    renderer.addBreak(750, 1000, new SimpleLineSymbol().setColor(new Color([182, 255, 143, 1.0])));
                    renderer.addBreak(1000, 1250, new SimpleLineSymbol().setColor(new Color([255, 200, 0, 1.0])));
                    renderer.addBreak(1250, Infinity, new SimpleLineSymbol().setColor(new Color([255, 0, 0, 1.0])));
        
                    mo2006GroundwaterElevation.setRenderer(renderer);
                }); */
                
                mo2006DepthToGroundwater.on("load", function() {
                
                    var defaultLineSymbol = null; // new SimpleLineSymbol();
                    //defaultLineSymbol.setColor(new Color([150, 150, 150, 0.5]));

                    // Add five breaks to the renderer.
                    // If you have ESRI's ArcMap available, this can be a good way to determine break values.
                    // You can also copy the RGB values from the color schemes ArcMap applies, or use colors
                    // from a site like www.colorbrewer.org
                    //
                    // alternatively, ArcGIS Server's generate renderer task could be used
                    var renderer = new ClassBreaksRenderer(defaultLineSymbol, "CONTOUR");
                    renderer.addBreak(0, 80, new SimpleLineSymbol().setColor(new Color([255, 0, 0, 1.0])));
                    renderer.addBreak(80, 140, new SimpleLineSymbol().setColor(new Color([255, 200, 0, 1.0])));
                    renderer.addBreak(140, 210, new SimpleLineSymbol().setColor(new Color([182, 255, 143, 1.0])));
                    renderer.addBreak(210, 290, new SimpleLineSymbol().setColor(new Color([51, 194, 255, 1.0])));
                    renderer.addBreak(290, Infinity, new SimpleLineSymbol().setColor(new Color([0, 0, 255, 1.0])));
        
                    mo2006DepthToGroundwater.setRenderer(renderer);
                    
                    mo2006DepthToGroundwater.on("mouse-move", showCoordinates);
                    mo2006DepthToGroundwater.on("mouse-drag", showCoordinates);
                });
                
                function showCoordinates(evt) {
                    console.log("show");
                    //get mapPoint from event
                    //The map is in web mercator - modify the map point to display the results in geographic
                    var mp = esri.geometry.webMercatorToGeographic(evt.mapPoint);
                    //display mouse coordinates
                    dojo.byId("gwinfo").innerHTML = mp.x.toFixed(3) + ", " + mp.y.toFixed(3);
                }
                 
                //Use renderer to create a simple red/green color ramp for losing/gaining stream segments
                //mo2011LosingGainingStreamSegments.on("load", function() {
                //    setRedGreenLineColorRenderer(mo2011LosingGainingStreamSegments);
                //});

                //Use renderer to create a simple red/green color ramp for losing/gaining stream segments
                mo2013LosingGainingStreamSegments.on("load", function() {
                    setRedGreenLineColorRenderer(mo2013LosingGainingStreamSegments);
                });

                function setRedGreenLineColorRenderer(lgsslayer) {
                    var defaultSymbol = new SimpleLineSymbol().setColor(new Color([0, 0, 255])); // blue
                    defaultSymbol.setWidth(0.5);
                    var losingSymbol = new SimpleLineSymbol().setColor(new Color([255, 0, 0])); // red
                    losingSymbol.setWidth(4);
                    var gainingSymbol = new SimpleLineSymbol().setColor(new Color([56, 168, 0])); // leaf green
                    gainingSymbol.setWidth(4);
                    //create renderer for losing/gaining stream segments
                    var lgssRenderer = new UniqueValueRenderer(defaultSymbol, "CLASS_");
                    //add symbol for each possible value
                    lgssRenderer.addValue("Losing", losingSymbol);
                    lgssRenderer.addValue("Gaining", gainingSymbol);
                    lgsslayer.setRenderer(lgssRenderer);
                }
                
                map.addLayers([mo2006DepthToGroundwater, mo1995StateHydrography, mo2013LosingGainingStreamSegments]);
                //mo2006GroundwaterElevation.hide();
                //console.log(mo2006GroundwaterElevation.visible);
                
                //Add Legend to the map
                //map.on is using the dojo event handler - on(eventType,listener), same as on(map,"layers-add-result","function(evt){...})
                //layers-add-result event is fired after all map layers have been added using map.addLayers
                map.on("layers-add-result", function (evt) {
				
                    var legend = new Legend({
                        map: map,
                        layerInfos: [{
                            layer: mo2006DepthToGroundwater,
                            title: "Groundwater Elevation"
                        }, {
                            layer: mo2013LosingGainingStreamSegments,
                            title: "Losing Gaining Stream Segments"
                        }] //if no layer is specified, all layer will be added to the legend
                    }, "legend");
                    legend.startup();
                    
                    if (!event.preventDefault) {
                        event.preventDefault = function() {
                            event.returnValue = false; //ie
                        };
                    }
                    //addLabels();
                });
                
                function addLabels() {
                    // create a text symbol to define the style of labels
                    var labelField = "STR_NAME";
                    var lgssLabel = new TextSymbol().setColor(new Color("#de2d26"));
                    lgssLabel.font.setSize("10pt");
                    lgssLabel.font.setFamily("arial");
                    lgssLabel.font.setWeight(esri.symbol.Font.WEIGHT_BOLD);
                    var lgssLabelRenderer = new SimpleRenderer(lgssLabel);
                    var labels = new LabelLayer({
                        id: "labels"
                    });
                    // tell the label layer to label the districts feature layer 
                    labels.addFeatureLayer(mo2013LosingGainingStreamSegments, lgssLabelRenderer, "${" + labelField + "}");
                    // add the label layer to the map
                    map.addLayer(labels);
                }
             });
    </script>
</head>

<body>
    <!--Add new element to store the user interface for widgets-->
    <div id="geocoder"></div>
    <div id="map", class="map">
        <div id="home"></div>
        <div id="BasemapToggle"></div>
        <div id="swipeDiv"></div>
        <span id="gwinfo" style="position:absolute; left:15px; bottom:5px; color:#000; z-index:50;"></span>
        <div id="info" style="font-size: 20px;">Legend
            <div id="legend"></div>
        </div>
    </div>
</body>
</html>
